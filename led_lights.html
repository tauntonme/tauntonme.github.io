<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Signals at West Buckland Railway</title>
	<meta name="description" content="'Brushless Brute' and 'Wedge' locomotives, days out in the park in Taunton and Bristol">
	<link rel="stylesheet" media="screen" href="s1.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Jon Freeman">
	<meta name="robots" content="all">
	<link href="http://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
</head>
<body>
<h2><b>Signals for West Buckland Miniature Railway</b></h2>
<h4>The purpose of the signalling system is to promote safer running of the railway.</h4>
<br />
<h4>LED Signals - Updated April 2025</h4>
<br />
	<figure class="polnp" style="float:left; width: 50%;border:16">
		<a target="_blank" href="img/LED_only_Disc23.jpg">
			<img src="img/LED_only_Disc23.jpg" style="width: 100%;border:10">
		</a>
		<figcaption>Signal LED Module - CAD Image - Bryter Layter</figcaption>
	</figure>
<br />
	<figure class="polnp" style="float:left; width: 50%;border:16">
		<a target="_blank" href="img/LED_Driver23_sch.png">
			<img src="img/LED_Driver23_sch.png" style="width: 100%;border:10">
		</a>
		<figcaption>Multicolour LED Controller - Schematic</figcaption>
	</figure>
<br />
	<p><b>Design of two LED Signal Heads has been completed - single and dual lamp models.</b></p>
	<p>The dual lamp version builds upon the technology used in the single. Both versions use a low cost STM32L431CB ARM Cortex microcontroller to provide up to 8 independent PWM (pulse width modulator) channels used to set light intensity for up to 8 LED circuits. Schematic (<a href="LED_Driver25 - Schematic.pdf" target="_blank">here.</a>)</p>
	<p>A sensor of ambient lighting has been included. This is used to modulate signal brightness for enhanced driver comfort.</p>
	<p>Future single lamp units will be part-built dual units to minimise inventory.</p>
		<p>Printed circuit files (<a href="LED_Driver25.zip">here</a>), code files all to be found in the code section.</p>
	<p>There it all is. Printed circuit design files, controller firmware, everything there is to know about it.</p>
	<p>End of April 2025 update.</p>
<p>Being much lower cost and easier to make than semaphores, LED light signals will be the default used on our railways.</p>
	<p>A first trial printed circuit board was designed using low-cost, low-power dual colour red/green leds.  No surprise, this was considered to be 'not bright enough'.
  Lesson learned, a new design was sought, but there are ways of going about these things.</p>
	<p>Experience has shown it can be unwise to source anything from unknown sources on the popular internet sales sites. 
    A more professional approach would involve looking at what's offered by reliable industrial component distributors (R.S., Farnell, Mouser etc),
   and choosing parts in volume production, from preferably more than one source.</p>
  <p>Single or multi colour, in short, a multi-colour device was selected, available from Cree
	  <a href="https://www.mouser.co.uk/datasheet/2/723/CLQ6B_TKW-2887154.pdf" target="_blank">(see data)</a>
	  and Osram
	  <a href="https://www.farnell.com/datasheets/3749809.pdf" target="_blank">(see data)</a>
	  . These contain four light sources - red, green, blue and white.
  These are designed for use in lighting, are five to ten times (depending how you measure it) brighter than our previous choices, and a board was designed
  to contain eight such devices. One potential problem, and the reason for our unsatisfactory first choice, whereas they could be soldered by human using a decent soldering iron,
  these newer devices are 'surface mount' with the connecting pads hidden underneath - you can't get an iron in there! 
    Fortunately we have found an electronics company in Somerset capable of doing this.</p>
<p>A two inch square board with LEDs mounted is part of the job.  Each LED will need to be supplied with a reasonably well regulated current to produce the light output we want,
   and these need to be switched from the signalling control system. Series resistors could be used, but we need to allow for power supply fluctuations,
 without affecting the brightness or operation of the signal.</p>
	<figure class="polnp" style="float:left; width: 50%;border:16">
		<a target="_blank" href="img/LED_Driver23_pcb.png">
			<img src="img/LED_Driver23_pcb.png" style="width: 100%;border:10">
		</a>
		<figcaption>Multicolour LED Controller - PCB</figcaption>
	</figure>
<br />
	<p>The eight LEDs are connected as a pair of series connected sets of four, in parallel.  The small resistors shown ensure currents in each set are
	substantialy the same.  This configuration should work well with supply voltage of 12V or above.</p>
  <p>Interrogating industrial component suppliers, a search was made for 'LED drivers', and an eminently suitable low cost (£0.65), variable brightness driver was found, 
  <a href="https://www.diodes.com/assets/Datasheets/AL8863.pdf" target="_blank">AL8863SP.</a></p>
  <p>With few extra components, four of these can accurately control the current to each of the four colours of LED.</p>
  <p>Driven by four pulse width modulator controller outputs, the lights are controllable to produce any blend of colours at all possible intensities.
  This is probably more than strictly needed for our signals, but provides a versatile platform for evaluation.</p>
<br />

	<p>The 'Multicolour LED Controller' schematic includes a full CAN bus interface.</p>
	<p>We have the choice of two methods of wiring all the site connections.  We could wire each item individually back to a central signal 'box'.  
		This would mean combining many twisted pairs (or whatever) into a big fat bundle entering the signal box.  This is the mid-20th century telephone exchange method.</p>
	<p>Alternatively, we can design a CAN bus interface into points, signals and any item of signalling equipment.  This requires just one twisted pair, daisy chaining all items where ever they are.  One aditional wire pair is required for power.</p>
	<p>Clearly, the simplicity of a full CAN bus implimentation is attractive, the down side being greater expense at every node (about £10 or thereabouts).</p>
	<p>The final outcome will be a mix-and-match, with, for example, the telephone exchange model used exclusively on the level crossing where cable runs are short,
	 with CAN bus devices at more distant positions.</p>
	<p>For lineside railway signals, whether LED or semaphore, the CAN bus interface is preferred as it requires only four electrical connections.  A non-CAN bus signal requires six.
	 If signal heads are regularly removed, a robust reasonably weather-proof connector will be needed. In this case four pole is preferred.</p>
<br />
	<figure class="polnp" style="float:left; width: 50%;border:16">
		<a target="_blank" href="img/Assembled_LED_board.png">
			<img src="img/Assembled_LED_board.png" style="width: 100%;border:10">
		</a>
		<figcaption>LED board built at Circuitbase, Bridgwater</figcaption>
	</figure>
<br />
	<p>Update March 2024 - Have now procured the PCBs and all components.  The prototype signal head consists of two 'piggy-backed' circuit boards, a controller system and the display boards.  Controllers were assembled 'in house', but the LED panels use surface mount devices that can not be soldered using traditional hand-soldering. Instead, the job of assembling a batch of 10 was offered to Circuitbase Ltd of Bridgwater.  Tiago, the main man there, was most helpful.  They did a great job, delivering 10 superbly assembled boards in double-quick time.  Excellent service, more work will surely be put their way. Well done!</p>
	<br />
	<p>A prototype circuit board was designed to take a few components including one ‘Nucleo L432KC’, four LED driver circuits, a MAX13054 CAN bus line driver, and a memory chip to store a unique node ID, so that separate signal heads may be individually addressed.  Once complete, the PCB design files were emailed to China, and a few days later the bare PCBs arrived.  Once built, it took little time before the coloured light system was drivable from the laptop using a USB connection.  This proved we could control the brightness of the four colours separately.  A ‘brightness’ control was written into the code to allow brightness settings from 0% (off) to 100% (max).  For working on the bench the full brightness was too painful to look at, further bench work continued with brightness reduced to just 1% !</p>  

<p>As often when working with prototypes, the need for a minor design modification became apparent.  During reprogramming or other times when the L432KC was not directly driving the LED drivers, the PWM outputs revert to high impedance allowing the LED drivers to default to maximum brightness.  This caused the failure of one LED module as the LED power rating assumes the equivalent maximum of any one LED at max power, or any two at half power, etc.  All four at full power together was enough to melt the silicon and let the smoke out.  This problem was solved with the addition of four ‘pull-down’ resistors to explicitly switch the LEDs off during these moments.</p>

<p>Half a century ago small resistors might have cost around three pence each.  Today, small surface mount resistors may be bought on reels of five thousand parts for around three pounds.  They are literally less than ‘ten a penny’.  While recklessly ‘splashing the cash’ in this way, it was decided to add another three resistors configured as a potential divider.  This would give the controller in the signal box the ability to read the supply voltage reaching any given signal.  Useful? Who knows?
</p>
	<p>For further information, see our video on <a href="https://www.facebook.com/jon.freeman.31105/videos/722360803412973" target="_blank">Facebook</a></p>
<br />
	<h3>CAN Bus workings and deeper tech stuff !</h3>
	<figure class="polnp" style="float:left; width: 50%;border:16">
		<a target="_blank" href="img/STM32CubeIDE.png">
			<img src="img/STM32CubeIDE.png" style="width: 100%;border:10">
		</a>
		<figcaption>Using STM32CubeIDE</figcaption>
	</figure>
<p>The last part to prove – CAN bus communication.  Last year we designed and built prototype signalling system controllers featuring, amongst many other features, a CAN bus port.  Having nothing to ‘talk to’, the CAN bus port remained untested.  The task remaining was to get a controller ‘talking to’ a signal head, and here we benefit from the high level of integration of the STM32 ‘ARM Cortex’ microcontroller family and the ease of use of the STM32CubeIDE.</p>

<p>At the design stage, the IDE helps in the choice of which chip pins we’re going to use for what purposes.  Most pins offer a choice of function but no pin can do everything.  The 'Using STM32CubeIDE' figure (left) shows the chip footprint in the IDE.  Selecting pins is as simple as clicking on the pin and choosing its function from a list.  In the centre pane we see selected the CAN setup data.  Here the prescaler and various time variables were fiddled with to get the ‘Baud Rate’ to 500000 bit/s.  All the rest were left as defaults.  The default option is most often the one we need!  Once we’ve been around all the setups for all the L432 features we are using, the IDE will ‘Generate Code’ for us, a file “main.c”, often around 600 lines of code.  This is all the ‘startup’ code where all sections of the computer get set up for us.  This represents a huge saving in work for us.  In earlier times, all of this would have been done by hand – a long, tedious and difficult task!  Much of the “main.c” file might seem impenetrable gobbledegook to the uninitiated, but we needn’t be too concerned.  Most of it we’ll never need to look at, but simple additions will be made in some of the areas clearly marked for our input.</p>

<p>Having gone around all the IDE options expressing our preferences, and with startup code generated, we can be almost certain all parts of the L432 will perform as we want.  For example, the selected timers will be working as pulse width modulators, and there will be no doubt the CAN bus interface is all setup ready for our use.  What it doesn’t help us with is how to go about batting messages back and forth over the CAN bus.  For that a search of the net found all that was missing.  A first class tutorial was found at <a href="https://controllerstech.com/can-protocol-in-stm32" target="_blank">https://controllerstech.com/can-protocol-in-stm32/</a></p>
<p>This is based around the STM32CubeIDE, and showed all we needed to know about messages and message filtering.  In a short time we had command messages being correctly sent and received between a signalling controller and two LED signal heads.  Very little time has been spent studying CAN bus protocols, little time spent reading about how it resolves conflicts, bus arbitration and all the finer technical detail.  Interesting as this may be, we don’t need to understand the engine to drive the car, so to speak.</p>

<p>With everything seen to work as expected, a polycarbonate enclosure was sourced into which the prototype almost fits.  A revised final PCB will fit perfectly.  The enclosure is IP67 rated, meaning it should be sufficiently weather-proof for outdoor installation.  Other changes between prototype and production include replacing the Nucleo L432 module with a ‘bare metal’ L432 computer chip variant with 48 pins instead of 32, simply to make the PCB layout easier.  This chip will cost around three pounds (half a pint) compared to the tenner for a Nucleo module, but will necessitate use of an external ‘ST-Link’ programmer (for a one-off cost around twenty pounds).
</p>
	<p>However, this is TME, where the 'lore' is that spanners will get thrown into any work in progress.  It has now been decreed lineside LED signals will include two lamps. Pain yes, big problem no, as this news came before the driver board reworking which can be made to accommodate two LED modules. Of course the revised design will not fit the enclosure previously sourced.</p>
</body>
</html>
